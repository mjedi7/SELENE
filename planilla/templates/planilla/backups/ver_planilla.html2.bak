{% extends 'planilla/menu.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Listado de Todos los Trabajadores</h2>

    <!-- Filtros personalizados -->
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="buscarClave" class="form-label">Buscar por Clave:</label>
            <input type="text" id="buscarClave" class="form-control" placeholder="Ingrese clave...">
        </div>
        <div class="col-md-5">
            <label for="buscarNombre" class="form-label">Buscar por Nombre:</label>
            <input type="text" id="buscarNombre" class="form-control" placeholder="Ingrese nombre...">
        </div>
    </div>

    <!-- Contenedor con scroll horizontal -->
    <div class="table-responsive" style="overflow-x: auto; white-space: nowrap;">
        <table id="tablaPlanilla" class="table table-striped table-bordered table-sm" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th>Datos</th>
                    <th>RFC</th>
                    <th>Clave</th>
                    <th>Nombre</th>
                    <th>Departamento</th>
                    <th>Puesto</th>
                    <th>Fecha inicio relación laboral</th>
                    <th>CURP</th>
                    <th>NSS</th>
                    <th>Sindicalizado</th>
                    <th>Activo</th>
                    <th>Baja</th>
                    <th>Quincenas como base</th>
                    <th>Nombramiento (Sí/No)</th>
                    <th>Observaciones</th>
                    <th>Categoría último nombramiento</th>
                    <th>Fecha último nombramiento</th>
                    <th>Firma último nombramiento</th>
                    <th>Género</th>
                    <th>Fecha nacimiento</th>
                    <th>Num. particular</th>
                    <th>Num. teléfono</th>
                    <th>C. estudios</th>
                    <th>Cédula</th>
                    <th>Universidad</th>
                    <th>Cédula validada</th>
                    <th>Calle</th>
                    <th>Colonia</th>
                    <th>Ciudad</th>
                    <th>CP</th>
                    <th>Fecha licencia</th>
                    <th>Motivo licencia</th>
                </tr>
            </thead>
            <tbody>
                {% for t in trabajadores %}
                <tr>
                    <td>
                        <button class="btn btn-primary btn-sm ver-datos">Ver datos</button>
                    </td>
                    <td>{{ t.rfc }}</td>
                    <td>{{ t.clave }}</td>
                    <td>{{ t.nombre }}</td>
                    <td>{{ t.departamento }}</td>
                    <td>{{ t.puesto }}</td>
                    <td>{{ t.fecha_inicio_rel_laboral }}</td>
                    <td>{{ t.curp }}</td>
                    <td>{{ t.nss }}</td>
                    <td>{{ t.sindicalizado }}</td>
                    <td>{{ t.activo }}</td>
                    <td>{{ t.baja }}</td>
                    <td>{{ t.quincenas_como_base }}</td>
                    <td>{{ t.nombramiento_si_no }}</td>
                    <td>{{ t.observaciones }}</td>
                    <td>{{ t.categoria_ultimo_nombramiento }}</td>
                    <td>{{ t.fecha_ultimo_nombramiento }}</td>
                    <td>{{ t.firma_ultimo_nombramiento }}</td>
                    <td>{{ t.genero }}</td>
                    <td>{{ t.fecha_nacimiento }}</td>
                    <td>{{ t.num_particular }}</td>
                    <td>{{ t.num_telefono }}</td>
                    <td>{{ t.c_estudios }}</td>
                    <td>{{ t.cedula }}</td>
                    <td>{{ t.universidad }}</td>
                    <td>{{ t.cedula_validada }}</td>
                    <td>{{ t.calle }}</td>
                    <td>{{ t.colonia }}</td>
                    <td>{{ t.ciudad }}</td>
                    <td>{{ t.cp }}</td>
                    <td>{{ t.fecha_licencia }}</td>
                    <td>{{ t.motivo_licencia }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Bootstrap -->
<div class="modal fade" id="modalTrabajador" tabindex="-1" aria-labelledby="modalTrabajadorLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalTrabajadorLabel">Datos del trabajador</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="modalDatos"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {
    var tabla = $('#tablaPlanilla').DataTable({
        "pageLength": 8,
        "scrollX": true,
        "autoWidth": false,
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
        }
    });

    // Filtro por clave (col 2)
    $('#buscarClave').on('keyup change', function () {
        tabla.column(2).search(this.value).draw();
    });

    // Filtro por nombre (col 3)
    $('#buscarNombre').on('keyup change', function () {
        tabla.column(3).search(this.value).draw();
    });

    // Modal por secciones
    $('#tablaPlanilla tbody').on('click', '.ver-datos', function () {
        var fila = $(this).closest('tr');
        var datos = tabla.row(fila).data();
        var columnas = tabla.columns().header().toArray().map(h => $(h).text());

        var trabajador = {};
        columnas.forEach((col, i) => {
            if (col !== "Datos") {
                trabajador[col] = datos[i] ?? "";
            }
        });

        var secciones = {
            "Datos Personales": ["Nombre", "RFC", "CURP", "Género", "Fecha nacimiento", "Num. particular", "Num. teléfono"],
            "Datos Laborales": ["Clave", "Departamento", "Puesto", "Fecha inicio relación laboral", "Sindicalizado", "Activo", "Baja", "Quincenas como base", "Nombramiento (Sí/No)", "Observaciones", "Categoría último nombramiento", "Fecha último nombramiento", "Firma último nombramiento"],
            "Datos Académicos": ["C. estudios", "Cédula", "Universidad", "Cédula validada"],
            "Domicilio": ["Calle", "Colonia", "Ciudad", "CP"],
            "Licencias": ["Fecha licencia", "Motivo licencia"]
        };

        var contenido = "";
        for (var seccion in secciones) {
            contenido += `<h5 class="mt-4 mb-3 text-primary">${seccion}</h5><div class="row">`;
            secciones[seccion].forEach(campo => {
                if (trabajador[campo] !== undefined) {
                    contenido += `
                        <div class="col-md-6 mb-3">
                            <div class="card shadow-sm border-0">
                                <div class="card-body">
                                    <h6 class="card-title text-muted">${campo}</h6>
                                    <p class="card-text fw-bold">${trabajador[campo]}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            contenido += `</div>`;
        }

        $("#modalDatos").html(contenido);
        var modal = new bootstrap.Modal(document.getElementById('modalTrabajador'));
        modal.show();
    });
});
</script>
{% endblock %}
